<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>6.824 MapReduce | KuangjuX(狂且)</title><meta name="keywords" content="分布式系统,6.824,go"><meta name="author" content="KuangjuX"><meta name="copyright" content="KuangjuX"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Lab-1 MapReduce 之前的版本是用 goroutine 写的，写错了，重新梳理一下想法： 首先，Master 启动并初始化状态，然后等待 Worker 来请求，此时的 Master 并不知道有多少台 Worker 工作，因此他会维护一个 WorkerState 的数组，此时这个数组为空，当 Worker 来连接 Master 的时候，Master 在数组里为其加入状态，并为其添加 I">
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta property="og:type" content="article">
<meta property="og:title" content="6.824 MapReduce">
<meta property="og:url" content="http://blog.kuangjux.top/2021/10/16/6-824-MapReduce/">
<meta property="og:site_name" content="KuangjuX(狂且)">
<meta property="og:description" content="Lab-1 MapReduce 之前的版本是用 goroutine 写的，写错了，重新梳理一下想法： 首先，Master 启动并初始化状态，然后等待 Worker 来请求，此时的 Master 并不知道有多少台 Worker 工作，因此他会维护一个 WorkerState 的数组，此时这个数组为空，当 Worker 来连接 Master 的时候，Master 在数组里为其加入状态，并为其添加 I">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/KuangjuX/Blog-Images/blob/main/MapReduce.png?raw=true">
<meta property="article:published_time" content="2021-10-16T13:43:13.000Z">
<meta property="article:modified_time" content="2021-10-16T13:51:37.328Z">
<meta property="article:author" content="KuangjuX">
<meta property="article:tag" content="分布式系统">
<meta property="article:tag" content="6.824">
<meta property="article:tag" content="go">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/KuangjuX/Blog-Images/blob/main/MapReduce.png?raw=true"><link rel="shortcut icon" href="/img/KuangjuX.png"><link rel="canonical" href="http://blog.kuangjux.top/2021/10/16/6-824-MapReduce/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-10-16 21:51:37'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="KuangjuX(狂且)" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/KuangjuX.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">74</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">49</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw video-camera"></i><span> Movies</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw book"></i><span> Books</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://github.com/KuangjuX/Blog-Images/blob/main/MapReduce.png?raw=true)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">KuangjuX(狂且)</a></span><span id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw video-camera"></i><span> Movies</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw book"></i><span> Books</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">6.824 MapReduce</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-10-16T13:43:13.000Z" title="Created 2021-10-16 21:43:13">2021-10-16</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-10-16T13:51:37.328Z" title="Updated 2021-10-16 21:51:37">2021-10-16</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="lab-1-mapreduce"><a class="markdownIt-Anchor" href="#lab-1-mapreduce"></a> Lab-1 MapReduce</h2>
<!-- hexo-inject:begin --><!-- hexo-inject:end --><p>之前的版本是用 goroutine 写的，写错了，重新梳理一下想法：</p>
<p>首先，Master 启动并初始化状态，然后等待 Worker 来请求，此时的 Master 并不知道有多少台 Worker 工作，因此他会维护一个 WorkerState 的数组，此时这个数组为空，当 Worker 来连接 Master 的时候，Master 在数组里为其加入状态，并为其添加 ID 号，并将其作为结果返回 Worker，此时 Worker 就知道自己的 ID 号了，在之后的请求中 Worker 将会带着这个 ID 号以便 Master 维护 Worker 的状态。</p>
<p>当 Worker 每次向 Master 请求并拿到 task 的时候，Worker 将会开启一个定时器来记录工作时间是否超时，倘若超时的话则说明 Worker 已经崩溃了，此时则将当前 Worker 运行的任务标记为 Idle， 当其他 Worker 请求的时候发送给其他 Worker。计时器计划采用 goroutine 来实现，为每一个 Worker 维护一个计时器，使用 channel 来发送消息，表示 Worker 是否超时，倘若超时则采取对应的策略。当所有 Map 任务都完成而此时 Reduce 数据还未处理完的时候则向对应的 Worker 发送 Wait 状态使 Worker 过一段时间再来请求。</p>
<p>Master 需要处理 Map 产生的中间文件并将其分到对应的 Bucket 中，这里打算使用 goroutine 来异步处理，当 Reduce 被分到对应的 Bucket 的时候，goroutine 向 Master 发送消息，此时当有 Worker 来请求任务时则向其派发 Reduce 任务。</p>
<p>当仍然有 Reduce 未完成时，此时当 Worker 来请求不能直接向 Worker 响应 Exit，因为有可能其他 Worker 宕机的情况，此时应当返回 Wait 使 Worker 处于等待状态，那么如果有 Worker 宕机了，Master 则将记录的 Worker 运行的任务发送给来请求的 Worker 重新运行。</p>
<p>一些数据结构的定义：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传输 Map 任务的结构体定义，MapID 记录的是第几个 Map 任务，</span></span><br><span class="line"><span class="comment">// 用来构建中间文件名，Filename 则用来传输 Map 的文件名</span></span><br><span class="line"><span class="keyword">type</span> MapTask <span class="keyword">struct</span> &#123;</span><br><span class="line">	MapID    <span class="keyword">int</span></span><br><span class="line">	FileName <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传输 Reduce 的结构体定义，ReduceID 记录第几个 Reduce 任务将要执行，</span></span><br><span class="line"><span class="comment">// Bucket 是 ReduceBucket, 维护了 key -&gt; values 的映射</span></span><br><span class="line"><span class="keyword">type</span> ReduceTask <span class="keyword">struct</span> &#123;</span><br><span class="line">	ReduceID <span class="keyword">int</span></span><br><span class="line">	Bucket   ReduceBucket</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Master 维护 Worker 状态，每次 Worker 向 Master 发出请求，</span></span><br><span class="line"><span class="comment">// Master 都会更新自己维护的 Worker 的状态</span></span><br><span class="line"><span class="keyword">type</span> WorkersState <span class="keyword">struct</span> &#123;</span><br><span class="line">	WID     <span class="keyword">int</span></span><br><span class="line">	WStatus <span class="keyword">int</span></span><br><span class="line">	MTask   MapTask</span><br><span class="line">	RTask   ReduceTask</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 Master 与 Worker 互相通信的结构体定义如下所示：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Worker 向 Master 请求任务，此时需要携带 WID 用来向</span></span><br><span class="line"><span class="comment">// Master 表明自己的身份，第一次请求携带 -1，表明自己是一台</span></span><br><span class="line"><span class="comment">// 没有与主机通信的及其，此时主机将会为其分配 WID 并将其作为响应返回</span></span><br><span class="line"><span class="keyword">type</span> TaskRequest <span class="keyword">struct</span> &#123;</span><br><span class="line">	WID <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Master 对 Worker 请求的响应，包含分配的 WID，任务状态，</span></span><br><span class="line"><span class="comment">// Map 或者 Reduce 任务的定义</span></span><br><span class="line"><span class="keyword">type</span> TaskResponse <span class="keyword">struct</span> &#123;</span><br><span class="line">	WID        <span class="keyword">int</span></span><br><span class="line">	TaskStatus <span class="keyword">int</span></span><br><span class="line">	MapTask    MapTask</span><br><span class="line">	ReduceTask ReduceTask</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Master 所维护的状态：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your definitions here.</span></span><br><span class="line">	nMap    <span class="keyword">int</span></span><br><span class="line">	nReduce <span class="keyword">int</span></span><br><span class="line">	<span class="comment">// 用来维护每个任务的状态，用来派发任务</span></span><br><span class="line">	MapStateLock sync.RWMutex</span><br><span class="line">	MapState     []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	ReduceStateLock sync.RWMutex</span><br><span class="line">	ReduceState     []<span class="keyword">int</span></span><br><span class="line">	<span class="comment">// 输入的文件名</span></span><br><span class="line">	Files []<span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// reduce buckets，用来派发 reduce tasks</span></span><br><span class="line">	Buckets []ReduceBucket</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 每个 Worker 的状态维护列表</span></span><br><span class="line">	WStates    []WorkersState</span><br><span class="line">	WorkerLock sync.RWMutex</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对于每个 Worker 维护的计时器channel</span></span><br><span class="line">	TimerChans []<span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Reduce数据是否已经准备好</span></span><br><span class="line">	IsReduceReady atomic.Value</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 所有任务是否已经完成</span></span><br><span class="line">	TaskEnd atomic.Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Worker 所维护的状态:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WorkerManager <span class="keyword">struct</span> &#123;</span><br><span class="line">	WID     <span class="keyword">int</span></span><br><span class="line">	MapF    <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">string</span>, <span class="keyword">string</span>)</span> []<span class="title">KeyValue</span></span></span><br><span class="line">	ReduceF <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">string</span>, []<span class="keyword">string</span>)</span> <span class="title">string</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 Worker 中的行为较为简单，只需在每次任务完成后向 Master 发送 RPC 请求即可：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(mapf <span class="keyword">func</span>(<span class="keyword">string</span>, <span class="keyword">string</span>)</span> []<span class="title">KeyValue</span>,</span></span><br><span class="line">	reducef <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">string</span>, []<span class="keyword">string</span>)</span> <span class="title">string</span>)</span> &#123;</span><br><span class="line">	<span class="comment">// 初始化管理者</span></span><br><span class="line">	<span class="keyword">var</span> manager WorkerManager</span><br><span class="line">	manager.WID = <span class="number">-1</span></span><br><span class="line">	manager.MapF = mapf</span><br><span class="line">	manager.ReduceF = reducef</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		req := TaskRequest&#123;</span><br><span class="line">			WID: manager.WID,</span><br><span class="line">		&#125;</span><br><span class="line">		rsp := TaskResponse&#123;&#125;</span><br><span class="line">		call(<span class="string">&quot;Coordinator.RequestTask&quot;</span>, &amp;req, &amp;rsp)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 更新管理者ID</span></span><br><span class="line">		<span class="keyword">if</span> manager.WID == <span class="number">-1</span> &#123;</span><br><span class="line">			manager.WID = rsp.WID</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> rsp.TaskStatus &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> Wait:</span><br><span class="line">			fmt.Printf(<span class="string">&quot;[Wait] Worker %v wait.\n&quot;</span>, manager.WID)</span><br><span class="line">			time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">		<span class="keyword">case</span> RunMapTask:</span><br><span class="line">			<span class="comment">// Run Map Task</span></span><br><span class="line">			fmt.Printf(<span class="string">&quot;[Map Task] Worker %v run map task %v.\n&quot;</span>, manager.WID, rsp.MapTask.MapID)</span><br><span class="line">			RunMapJob(rsp.MapTask, manager.MapF)</span><br><span class="line">		<span class="keyword">case</span> RunReduceTask:</span><br><span class="line">			<span class="comment">// Run Reduce Task</span></span><br><span class="line">			fmt.Printf(<span class="string">&quot;[Map Task] Worker %v run reduce task %v.\n&quot;</span>, manager.WID, rsp.ReduceTask.ReduceID)</span><br><span class="line">			RunReduceJob(rsp.ReduceTask, manager.ReduceF)</span><br><span class="line">		<span class="keyword">case</span> Exit:</span><br><span class="line">			<span class="comment">// Call Master to finish</span></span><br><span class="line">			fmt.Printf(<span class="string">&quot;[Exit] Worker %v exit.\n&quot;</span>, manager.WID)</span><br><span class="line">			RunExitJob()</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 Master 的核心处理逻辑则较为复杂，因为它需要调度 Worker 去运行不同的任务，并判断是否有 Worker 宕机了。</p>
 <figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span> <span class="title">RequestTask</span><span class="params">(req *TaskRequest, rsp *TaskResponse)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 如果此时Worker是第一次请求的话，为其分配id</span></span><br><span class="line">	<span class="comment">// 并在WStates加入对应的结构</span></span><br><span class="line">	c.UpdateTaskState(req.WID)</span><br><span class="line">	<span class="keyword">if</span> req.WID == <span class="number">-1</span> &#123;</span><br><span class="line">		<span class="comment">// 为Worker分配索引号</span></span><br><span class="line">		rsp.WID = <span class="built_in">len</span>(c.WStates)</span><br><span class="line">		c.WorkerLock.Lock()</span><br><span class="line">		c.WStates = <span class="built_in">append</span>(c.WStates, WorkersState&#123;&#125;)</span><br><span class="line">		c.WorkerLock.Unlock()</span><br><span class="line">		c.TimerChans = <span class="built_in">append</span>(c.TimerChans, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>))</span><br><span class="line">		<span class="comment">// fmt.Printf(&quot;分配的 Worker id 为 %v.\n&quot;, rsp.WID)</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 将WID作为局部变量赋值，方便之后的处理</span></span><br><span class="line">	<span class="keyword">var</span> WID <span class="keyword">int</span></span><br><span class="line">	<span class="keyword">if</span> req.WID == <span class="number">-1</span> &#123;</span><br><span class="line">		WID = rsp.WID</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		WID = req.WID</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 循环Master的Map任务状态，判断是否所有任务都完成了</span></span><br><span class="line">	<span class="comment">// 否则为Worker分发任务</span></span><br><span class="line">	<span class="comment">// c.MapStateLock.Lock()</span></span><br><span class="line">	<span class="comment">// c.MapStateLock.RLock()</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(c.MapState); i++ &#123;</span><br><span class="line">		<span class="comment">// c.MapStateLock.RLock()</span></span><br><span class="line">		<span class="keyword">if</span> c.MapState[i] == Idle &#123;</span><br><span class="line">			<span class="comment">// c.MapStateLock.RUnlock()</span></span><br><span class="line">			c.MapStateLock.Lock()</span><br><span class="line">			c.MapState[i] = Progress</span><br><span class="line">			c.MapStateLock.Unlock()</span><br><span class="line"></span><br><span class="line">			fmt.Printf(<span class="string">&quot;[Map Task] 此时 Worker %v 运行 %v 号任务.\n&quot;</span>, WID, i)</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 更新对于Map任务状态</span></span><br><span class="line">			rsp.TaskStatus = RunMapTask</span><br><span class="line">			rsp.MapTask = MapTask&#123;</span><br><span class="line">				MapID:    i,</span><br><span class="line">				FileName: c.Files[i],</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 更新Master的对该Worker的状态维护</span></span><br><span class="line">			c.WorkerLock.Lock()</span><br><span class="line">			c.WStates[WID].WStatus = RunMapTask</span><br><span class="line">			c.WStates[WID].MTask = rsp.MapTask</span><br><span class="line">			c.WorkerLock.Unlock()</span><br><span class="line">			<span class="keyword">go</span> c.StartTimer(WID, c.TimerChans[WID])</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// c.MapStateLock.Unlock()</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// c.MapStateLock.RUnlock()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果没有准备好Reduce Bucket，则进入等待状态</span></span><br><span class="line">	<span class="comment">// c.ReadyLock.RLock()</span></span><br><span class="line">	<span class="keyword">if</span> c.IsReduceReady.Load() == <span class="literal">false</span> &#123;</span><br><span class="line">		rsp.WID = WID</span><br><span class="line">		rsp.TaskStatus = Wait</span><br><span class="line">		<span class="comment">// 更新Master对于Worker的状态</span></span><br><span class="line">		c.WorkerLock.Lock()</span><br><span class="line">		c.WStates[WID].WStatus = Wait</span><br><span class="line">		c.WorkerLock.Unlock()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// c.ReadyLock.RUnlock()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// c.ReduceStateLock.RLock()</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(c.ReduceState); i++ &#123;</span><br><span class="line">		<span class="comment">// c.ReduceStateLock.RLock()</span></span><br><span class="line">		<span class="keyword">if</span> c.ReduceState[i] == Idle &#123;</span><br><span class="line">			<span class="comment">// c.ReduceStateLock.RUnlock()</span></span><br><span class="line">			c.ReduceStateLock.Lock()</span><br><span class="line">			c.ReduceState[i] = Progress</span><br><span class="line">			c.ReduceStateLock.Unlock()</span><br><span class="line"></span><br><span class="line">			fmt.Printf(<span class="string">&quot;[Reduce Task] 此时 Worker %v 运行 %v 号任务.\n&quot;</span>, WID, i)</span><br><span class="line"></span><br><span class="line">			rsp.TaskStatus = RunReduceTask</span><br><span class="line">			rsp.ReduceTask = ReduceTask&#123;</span><br><span class="line">				ReduceID: i,</span><br><span class="line">				Bucket:   c.Buckets[i],</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 更新Master对Worker的维护信息</span></span><br><span class="line">			c.WorkerLock.Lock()</span><br><span class="line">			c.WStates[WID] = WorkersState&#123;</span><br><span class="line">				WID:     WID,</span><br><span class="line">				WStatus: RunReduceTask,</span><br><span class="line">				RTask: ReduceTask&#123;</span><br><span class="line">					ReduceID: i,</span><br><span class="line">					Bucket:   c.Buckets[i],</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;</span><br><span class="line">			c.WorkerLock.Unlock()</span><br><span class="line">			<span class="keyword">go</span> c.StartTimer(WID, c.TimerChans[WID])</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// c.ReduceStateLock.RUnlock()</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// c.TaskLock.RLock()</span></span><br><span class="line">	<span class="keyword">if</span> c.TaskEnd.Load() == <span class="literal">false</span> &#123;</span><br><span class="line">		rsp.WID = WID</span><br><span class="line">		rsp.TaskStatus = Wait</span><br><span class="line">		<span class="comment">// 更新Master状态</span></span><br><span class="line">		c.WorkerLock.Lock()</span><br><span class="line">		c.WStates[WID] = WorkersState&#123;</span><br><span class="line">			WID:     WID,</span><br><span class="line">			WStatus: Wait,</span><br><span class="line">		&#125;</span><br><span class="line">		c.WorkerLock.Unlock()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// c.TaskLock.RUnlock()</span></span><br><span class="line"></span><br><span class="line">	rsp.TaskStatus = Exit</span><br><span class="line">	c.WorkerLock.Lock()</span><br><span class="line">	c.WStates[WID].WStatus = Exit</span><br><span class="line">	c.WorkerLock.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>通过的测试用例</strong>：</p>
<ul>
<li>[x] wc</li>
<li>[x] indexer</li>
<li>[x] jobcount</li>
<li>[x] mtiming</li>
<li>[x] rtiming</li>
<li>[x] early_exit</li>
<li>[x] nocrash</li>
<li>[x] crash</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">KuangjuX</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://blog.kuangjux.top/2021/10/16/6-824-MapReduce/">http://blog.kuangjux.top/2021/10/16/6-824-MapReduce/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a><a class="post-meta__tags" href="/tags/6-824/">6.824</a><a class="post-meta__tags" href="/tags/go/">go</a></div><div class="post_share"><div class="social-share" data-image="https://github.com/KuangjuX/Blog-Images/blob/main/MapReduce.png?raw=true" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/16/6-824-Lab2A/"><img class="prev-cover" src="https://github.com/KuangjuX/Blog-Images/blob/main/Raft.png?raw=true" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">6.824 Lab2 Leader Election</div></div></a></div><div class="next-post pull-right"><a href="/2021/07/07/The-forest-in-Norway/"><img class="next-cover" src="https://github.com/KuangjuX/Blog-Images/blob/main/The-forests-in-Norway.jpg?raw=true" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">挪威的森林</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2021/10/16/6-824-Lab2A/" title="6.824 Lab2 Leader Election"><img class="cover" src="https://github.com/KuangjuX/Blog-Images/blob/main/Raft.png?raw=true" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-16</div><div class="title">6.824 Lab2 Leader Election</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/KuangjuX.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">KuangjuX</div><div class="author-info__description">狂且的人文及技术博客</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">74</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">49</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/KuangjuX"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/KuangjuX" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="/zhjyyjjmjy666@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="card-widget card-announcement"><div class="card-content"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">风声雨声读书声，声声入耳 </br> 家事国事天下事，事事关心</div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#lab-1-mapreduce"><span class="toc-text"> Lab-1 MapReduce</span></a></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/10/%E6%8F%90%E9%AB%98-Directory-Cache-%E6%80%A7%E8%83%BD/" title="提高 Directory Cache 性能"><img src="https://github.com/KuangjuX/Blog-Images/blob/main/circuit1.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="提高 Directory Cache 性能"/></a><div class="content"><a class="title" href="/2022/04/10/%E6%8F%90%E9%AB%98-Directory-Cache-%E6%80%A7%E8%83%BD/" title="提高 Directory Cache 性能">提高 Directory Cache 性能</a><time datetime="2022-04-10T04:28:21.000Z" title="Created 2022-04-10 12:28:21">2022-04-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/12/Cache/" title="高速缓存技术(Cache)"><img src="https://github.com/KuangjuX/Blog-Images/blob/main/circuit2.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="高速缓存技术(Cache)"/></a><div class="content"><a class="title" href="/2022/03/12/Cache/" title="高速缓存技术(Cache)">高速缓存技术(Cache)</a><time datetime="2022-03-12T06:27:41.000Z" title="Created 2022-03-12 14:27:41">2022-03-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/05/Chisel-learning/" title="Chisel 学习笔记"><img src="https://github.com/KuangjuX/Blog-Images/blob/main/circuit2.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Chisel 学习笔记"/></a><div class="content"><a class="title" href="/2022/03/05/Chisel-learning/" title="Chisel 学习笔记">Chisel 学习笔记</a><time datetime="2022-03-05T13:31:07.000Z" title="Created 2022-03-05 21:31:07">2022-03-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/04/essay/" title="随笔（一）"><img src="https://github.com/KuangjuX/Blog-Images/blob/main/book1.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="随笔（一）"/></a><div class="content"><a class="title" href="/2022/03/04/essay/" title="随笔（一）">随笔（一）</a><time datetime="2022-03-04T14:22:51.000Z" title="Created 2022-03-04 22:22:51">2022-03-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/04/ILP/" title="指令级并行技术"><img src="https://github.com/KuangjuX/Blog-Images/blob/main/circuit1.jpg?raw=true" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="指令级并行技术"/></a><div class="content"><a class="title" href="/2022/03/04/ILP/" title="指令级并行技术">指令级并行技术</a><time datetime="2022-03-04T14:14:04.000Z" title="Created 2022-03-04 22:14:04">2022-03-04</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By KuangjuX</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="icp"><a><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>津ICP备20003770号</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div><!-- hexo-inject:begin --><!-- hexo-inject:end --></body></html>